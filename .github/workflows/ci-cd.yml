name: CI/CD Pipeline

on:
  push:
    branches:
      - dev
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Build the project
        run: npm run build

      - name: Determine Environment
        id: set-env
        run: |
          if [[ '${{ github.ref }}' == 'refs/heads/main' ]]; then
            echo "ENV=production" >> $GITHUB_ENV
          else
            echo "ENV=development" >> $GITHUB_ENV
          fi

      - name: Set Database URL for Production
        if: ${{ github.env.ENV }} == 'production'
        run: echo "DATABASE_URL=${{ secrets.DATABASE_URL_PROD }}" >> $GITHUB_ENV
        shell: bash

      - name: Set Database URL for Development
        if: ${{ github.env.ENV }} == 'development'
        run: echo "DATABASE_URL=${{ secrets.DATABASE_URL_DEV }}" >> $GITHUB_ENV
        shell: bash

      - name: Backup Database (Before Migration)
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          BACKUP_PATH: ${{ secrets.BACKUP_PATH }}
        run: |
          mkdir -p "$BACKUP_PATH"
          if [[ -z "$DATABASE_URL" || -z "$BACKUP_PATH" ]]; then
            echo "Error: DATABASE_URL or BACKUP_PATH is not set properly."
            exit 1
          fi
          
          # Parse database connection parameters from DATABASE_URL
          DB_USER=$(echo $DATABASE_URL | sed -n 's/^postgresql:\/\/\([^:]*\):.*@.*$/\1/p')
          DB_PASSWORD=$(echo $DATABASE_URL | sed -n 's/^postgresql:\/\/[^:]*:\([^@]*\)@.*$/\1/p')
          DB_HOST=$(echo $DATABASE_URL | sed -n 's/^postgresql:\/\/[^@]*@\([^:]*\):.*$/\1/p')
          DB_PORT=$(echo $DATABASE_URL | sed -n 's/^postgresql:\/\/[^@]*:[0-9]*:\([^\/]*\)\/.*$/\1/p')
          DB_NAME=$(echo $DATABASE_URL | sed -n 's/^postgresql:\/\/[^@]*:^)lin
